<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Archipelago Dashboard V3.0</title>
  
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Bibliotecas Externas -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    /* =================== VARI√ÅVEIS CSS GLOBAIS - 55 CORES PANTONE =================== */
    :root {
      /* Cores Principais do Sistema */
      --nav-header: #1a1f2e;
      --nav-sidebar: #1a1f2e;
      --bg-primary: #ffffff;
      --card: #1a1f2e;
      --card-hover: #242938;
      --text-white: #ffffff;
      --text: #ffffff;
      --text-muted: #e2e8f0;
      --text-accent: #60a5fa;
      --border: #334155;

      /* Status dos Leitos */
      --status-vago: #16a34a;
      --status-uso: #fbbf24;
      --status-uti: #dc2626;
      --destaque: #8FD3F4;

      /* Timeline de Altas */
      --ouro: #fbbf24;
      --r2: #3b82f6;
      --r3: #8b5cf6;
      --sp: #6b7280;

      /* Concess√µes - 13 Cores Pantone */
      --conc-transicao: #007A53;
      --conc-aplicacao: #582C83;
      --conc-fisioterapia: #009639;
      --conc-fonoaudiologia: #FF671F;
      --conc-aspiracao: #2E1A47;
      --conc-banho: #8FD3F4;
      --conc-curativos: #00BFB3;
      --conc-oxigenoterapia: #64A70B;
      --conc-recarga: #00AEEF;
      --conc-nutricional-com: #FFC72C;
      --conc-nutricional-sem: #F4E285;
      --conc-clister: #E8927C;
      --conc-picc: #E03C31;

      /* Linhas de Cuidado - 19 Cores Pantone */
      --linha-assiste: #ED0A72;
      --linha-aps: #007A33;
      --linha-paliativos: #00B5A2;
      --linha-ico: #A6192E;
      --linha-oncologia: #6A1B9A;
      --linha-pediatria: #5A646B;
      --linha-auto-gastro: #5C5EBE;
      --linha-auto-neuro-desm: #00AEEF;
      --linha-auto-neuro-musc: #00263A;
      --linha-auto-reumato: #582D40;
      --linha-vida-leve: #FFB81C;
      --linha-card: #C8102E;
      --linha-endocrino: #582C83;
      --linha-geriatria: #FF6F1D;
      --linha-melhor: #556F44;
      --linha-neurologia: #0072CE;
      --linha-pneumologia: #E35205;
      --linha-pos-bariatrica: #003C57;
      --linha-reumatologia: #5A0020;

      /* Hospitais - 6 Cores */
      --hospital-neomater: #ffffff;
      --hospital-neomater-text: #0a2b52;
      --hospital-cruz-azul: #60a5fa;
      --hospital-santa-marcelina: #8b5cf6;
      --hospital-santa-clara: #f59e0b;
      --hospital-extra-1: #22c55e;
      --hospital-extra-2: #ef4444;

      /* Efeitos e Sombras */
      --shadow: 0 4px 12px rgba(11,44,82,.08);
      --shadow-2: 0 10px 28px rgba(11,44,82,.12);
      --gradient-card: linear-gradient(145deg, var(--card) 0%, var(--card-hover) 100%);
      --gradient-button: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
    }

    /* =================== ESTILOS BASE =================== */
    * { box-sizing: border-box; }
    
    html, body {
      height: 100%; margin: 0; padding: 0; overflow-x: hidden;
      font-family: 'Open Sans', sans-serif;
      background: var(--bg-primary);
      color: var(--text);
      padding-left: 0;
      transition: padding-left 0.3s ease;
    }

    body.menu-open {
      padding-left: 280px;
    }

    /* =================== MODAL DE AUTENTICA√á√ÉO =================== */
    #authModal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(10, 15, 28, 0.98); backdrop-filter: blur(20px);
      display: flex; align-items: center; justify-content: center;
      z-index: 3000;
    }

    .auth-container {
      background: var(--gradient-card); max-width: 400px; width: 90%;
      border-radius: 20px; border: 1px solid var(--border);
      box-shadow: var(--shadow-2); padding: 40px 30px; text-align: center;
    }

    .auth-header h1 {
      margin: 0 0 10px 0; font-size: 24px; font-weight: 700;
      text-transform: uppercase; letter-spacing: 1px; color: var(--text-white);
    }

    .auth-header p {
      margin: 0; font-size: 14px; color: var(--text-muted); font-weight: 600;
    }

    .auth-input {
      width: 100%; padding: 15px 20px; border: 2px solid var(--border);
      border-radius: 12px; background: var(--card); color: var(--text);
      font-weight: 600; font-size: 18px; text-align: center;
      letter-spacing: 2px; margin: 30px 0 20px 0; transition: all 0.3s ease;
    }

    .auth-input:focus {
      outline: none; border-color: var(--text-accent);
      box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1);
    }

    .auth-btn {
      width: 100%; background: var(--gradient-button); border: 1px solid var(--text-accent);
      color: var(--text-white); border-radius: 12px; padding: 15px;
      cursor: pointer; font-weight: 700; text-transform: uppercase;
      letter-spacing: 1px; font-size: 16px;
      box-shadow: 0 4px 16px rgba(96, 165, 250, 0.3);
    }

    .auth-error {
      color: var(--status-uti); font-size: 12px; font-weight: 600;
      margin-top: 10px; opacity: 0; transition: opacity 0.3s ease;
    }

    .auth-error.show { opacity: 1; }

    /* =================== LOADING OVERLAY =================== */
    #loadingOverlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(10, 15, 28, 0.95); backdrop-filter: blur(10px);
      display: none; flex-direction: column; align-items: center; justify-content: center;
      z-index: 2000;
    }

    .loading-spinner {
      width: 60px; height: 60px; border: 3px solid var(--border);
      border-top: 3px solid var(--text-accent); border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    .loading-text {
      margin-top: 15px; font-size: 16px; color: var(--text);
      font-weight: 600; text-transform: uppercase; letter-spacing: 1px;
    }

    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* =================== HEADER PRINCIPAL =================== */
    header {
      background: var(--nav-header); color: var(--text-white); padding: 15px 24px;
      display: flex; align-items: center; justify-content: space-between;
      box-shadow: var(--shadow-2); border-bottom: 1px solid var(--border);
      position: sticky; top: 0; z-index: 100; height: 60px;
    }

    .header-left { display: flex; align-items: center; gap: 20px; }
    
    .hamburger-menu { 
      font-size: 24px; cursor: pointer; padding: 8px;
      border-radius: 8px; transition: all 0.3s ease;
    }

    .hamburger-menu:hover {
      background: rgba(255, 255, 255, 0.1); transform: scale(1.1);
    }

    .brand h1 {
      margin: 0; font-size: 20px; font-weight: 700;
      text-transform: uppercase; letter-spacing: 1px;
    }

    .header-right { display: flex; align-items: center; gap: 16px; }

    #updateTimer {
      font-size: 12px; color: var(--text-muted); font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.5px;
      background: rgba(255, 255, 255, 0.1); padding: 6px 12px;
      border-radius: 8px; border: 1px solid var(--border);
    }

    .header-btn {
      background: var(--gradient-button); border: 1px solid var(--border);
      color: var(--text-white); border-radius: 10px; padding: 8px 12px;
      cursor: pointer; font-weight: 600; text-transform: uppercase;
      letter-spacing: 0.5px; box-shadow: 0 4px 12px rgba(96, 165, 250, 0.3);
    }

    /* =================== MENU LATERAL =================== */
    #side-menu {
      position: fixed; top: 0; left: -280px; width: 280px; height: 100%;
      background: var(--nav-sidebar); box-shadow: var(--shadow-2);
      border-right: 1px solid var(--border); z-index: 1001;
      padding-top: 60px; transition: left 0.3s ease;
      display: flex; flex-direction: column;
    }

    #side-menu.open { left: 0; }

    .close-menu-btn { 
      position: absolute; top: 15px; right: 15px; font-size: 14px;
      cursor: pointer; background: rgba(255,255,255,0.15);
      padding: 6px 10px; border-radius: 6px;
      border: 1px solid rgba(255,255,255,0.25);
      color: var(--text-white); font-weight: 600;
    }

    .menu-items { flex: 1; padding: 0 0 120px 0; overflow-y: auto; }

    .side-menu-item {
      display: flex; align-items: center; gap: 15px;
      padding: 20px 25px; color: var(--text-white); text-decoration: none;
      font-size: 16px; font-weight: 600; text-transform: uppercase;
      letter-spacing: 0.5px; border-left: 4px solid transparent;
      transition: all 0.3s ease; height: 60px; cursor: pointer;
    }

    .side-menu-item:hover {
      background: rgba(255, 255, 255, 0.1);
      border-left-color: var(--text-white);
    }

    .side-menu-item.active {
      background: rgba(255, 255, 255, 0.2);
      border-left-color: var(--text-white);
    }

    .menu-footer { position: absolute; bottom: 20px; left: 20px; right: 20px; }

    .settings-menu-btn {
      width: 100%; background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2); color: var(--text-white);
      border-radius: 12px; padding: 15px; cursor: pointer;
      font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;
      display: flex; align-items: center; justify-content: center; gap: 10px;
    }

    .settings-dropdown-menu {
      display: none; position: absolute; bottom: 110%; left: 0; right: 0;
      background: var(--card); border-radius: 12px; box-shadow: var(--shadow);
      overflow: hidden; border: 1px solid var(--border); margin-bottom: 10px;
    }

    .settings-dropdown-menu.show { display: block; }

    .settings-dropdown-item {
      padding: 12px 15px; color: var(--text); font-size: 14px;
      cursor: pointer; font-weight: 600; text-transform: uppercase;
      letter-spacing: 0.5px; border-bottom: 1px solid var(--border);
    }

    .settings-dropdown-item:hover { background: var(--card-hover); }

    /* =================== MAIN CONTENT =================== */
    main {
      max-width: 1600px; margin: 18px auto 100px; padding: 0 24px;
      background: rgba(255, 255, 255, 0.95); border-radius: 20px;
      border: 1px solid #e5e5e5; box-shadow: var(--shadow);
    }

    /* =================== SELETORES DE HOSPITAL =================== */
    .hospital-selector {
      display: flex; justify-content: center; gap: 20px; margin: 20px 0 30px 0;
      padding: 20px; background: var(--nav-header);
      border-radius: 16px; border: 1px solid var(--border); flex-wrap: wrap;
    }

    .hospital-btn {
      background: var(--gradient-button); border: 1px solid var(--border);
      color: var(--text-white); border-radius: 12px; padding: 12px 24px;
      cursor: pointer; font-weight: 600; text-transform: uppercase;
      letter-spacing: 0.5px; transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(96, 165, 250, 0.3);
      font-size: 16px; flex: 1; min-width: 200px;
    }

    .hospital-btn:hover {
      background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
      box-shadow: 0 4px 16px rgba(96, 165, 250, 0.4);
    }

    .hospital-btn[data-hospital="H1"].active {
      background: var(--hospital-neomater);
      color: var(--hospital-neomater-text);
      border-color: var(--hospital-neomater-text);
    }

    .hospital-btn[data-hospital="H2"].active {
      background: var(--hospital-cruz-azul);
      color: #ffffff; border-color: var(--hospital-cruz-azul);
    }

    .hospital-btn[data-hospital="H3"].active {
      background: var(--hospital-santa-marcelina);
      color: #ffffff; border-color: var(--hospital-santa-marcelina);
    }

    .hospital-btn[data-hospital="H4"].active {
      background: var(--hospital-santa-clara);
      color: #ffffff; border-color: var(--hospital-santa-clara);
    }

    /* =================== GRID E CARDS =================== */
    .grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
      gap: 18px; position: relative; z-index: 1;
    }

    .card {
      background: var(--gradient-card); border-radius: 20px; padding: 16px;
      box-shadow: var(--shadow); border: 1px solid var(--border);
      transform: translateY(0); transition: transform 0.18s ease, box-shadow 0.18s ease;
      color: #ffffff;
    }

    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 16px 38px rgba(11,44,82,.16);
    }

    .card * { color: inherit; }

    .section-title {
      color: #ffffff; background: var(--text-accent);
      padding: 8px 12px; border-radius: 6px; margin-bottom: 8px;
      font-size: 11px; font-weight: 700; text-transform: uppercase;
    }

    .leito-badge {
      background: var(--status-vago); color: #ffffff; font-weight: 700;
      text-transform: uppercase; letter-spacing: 1px; padding: 10px 12px;
      border-radius: 8px; font-size: 12px; text-align: center;
      display: flex; align-items: center; justify-content: center; min-height: 40px;
    }

    .leito-badge.ocupado {
      background: var(--status-uso); color: #000000;
    }

    .chip-item {
      font-size: 10px; background: rgba(96, 165, 250, 0.1);
      border: 1px solid var(--border); color: var(--text-accent);
      padding: 2px 6px; border-radius: 999px; font-weight: 600;
      margin: 2px; display: inline-block;
    }

    /* =================== DASHBOARDS =================== */
    .executive-kpis-grid {
      display: grid; grid-template-columns: repeat(6, 1fr);
      grid-template-rows: repeat(2, 120px); gap: 16px; margin-bottom: 30px;
      padding: 20px; background: var(--card); border-radius: 16px;
      border: 1px solid var(--border);
    }

    .kpi-principal {
      background: var(--gradient-card); border-radius: 12px;
      border: 1px solid var(--border); display: flex; align-items: center;
      padding: 20px; color: var(--text-white); grid-column: 1 / 3; grid-row: 1 / 3;
    }

    .gauge-container {
      display: flex; align-items: center; width: 100%; gap: 20px;
    }

    .hospitais-list {
      flex: 1; display: flex; flex-direction: column; gap: 8px;
    }

    .hospital-item {
      display: flex; justify-content: space-between; align-items: center;
      font-size: 12px; color: var(--text-white);
    }

    .hospital-nome { font-weight: 600; }
    .hospital-pct { font-weight: 700; color: var(--text-accent); }

    .kpi-box {
      background: var(--gradient-card); border-radius: 12px;
      border: 1px solid var(--border); display: flex; flex-direction: column;
      align-items: center; justify-content: center; text-align: center;
      color: var(--text-white);
    }

    .kpi-value {
      font-size: 28px; font-weight: 700; color: var(--text-accent); margin-bottom: 4px;
    }

    .kpi-label {
      font-size: 11px; font-weight: 600; text-transform: uppercase;
      letter-spacing: 0.5px; color: var(--text-muted);
    }

    .dashboard-card {
      background: var(--gradient-card); border: 1px solid var(--border);
      border-radius: 16px; padding: 20px; box-shadow: var(--shadow);
      margin-bottom: 24px; color: var(--text-white);
    }

    .dashboard-card h3 {
      margin: 0 0 15px 0; font-size: 18px; color: var(--text-white);
      text-align: center; padding-bottom: 10px; border-bottom: 1px solid var(--border);
      font-weight: 700; text-transform: uppercase; letter-spacing: 1px;
    }

    .chart-container { position: relative; width: 100%; }
    .h-250 { height: 250px; }
    .h-300 { height: 300px; }
    .h-400 { height: 400px; }

    /* =================== RESPONSIVIDADE =================== */
    @media (max-width: 1024px) {
      body.menu-open { padding-left: 0; }
      
      .executive-kpis-grid {
        grid-template-columns: repeat(2, 1fr); grid-template-rows: auto;
      }
      
      .kpi-principal { grid-column: 1 / 3; grid-row: auto; }
    }

    @media (max-width: 768px) {
      .grid { grid-template-columns: 1fr; }
      .hospital-selector { flex-direction: column; gap: 10px; }
      .hospital-btn { width: 100%; min-width: auto; flex: none; }
    }

    /* =================== MODAIS =================== */
    .backdrop {
      position: fixed; inset: 0; background: rgba(10, 15, 28, 0.8);
      backdrop-filter: blur(10px); display: none; align-items: center;
      justify-content: center; padding: 16px; z-index: 2000; overflow: auto;
    }

    .modal {
      background: var(--gradient-card); max-width: 860px; width: 100%;
      max-height: 90vh; border-radius: 20px; border: 1px solid var(--border);
      box-shadow: var(--shadow-2); overflow: hidden; display: flex;
      flex-direction: column;
    }

    .modal header {
      background: var(--nav-header); border-bottom: 1px solid var(--border);
      color: var(--text-white); display: flex; align-items: center;
      justify-content: space-between; padding: 12px 16px; flex-shrink: 0;
    }

    .modal .content { padding: 16px; overflow-y: auto; flex: 1; }

    .modal .actions {
      background: rgba(26, 31, 46, 0.5); border-top: 1px solid var(--border);
      display: flex; gap: 8px; justify-content: flex-end;
      padding: 12px 16px; flex-shrink: 0;
    }

    .btn {
      appearance: none; border: 1px solid var(--border);
      background: var(--card); padding: 10px 14px; border-radius: 12px;
      cursor: pointer; color: var(--text); font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.5px;
    }

    .btn.primary {
      background: var(--gradient-button); border-color: var(--text-accent);
      color: var(--text-white);
    }

    .btn.danger {
      background: linear-gradient(135deg, var(--status-uti) 0%, #991b1b 100%);
      border-color: var(--status-uti); color: var(--text-white);
    }

    .hidden { display: none; }

    /* =================== SYSTEM FOOTER =================== */
    .system-footer {
      margin-top: 40px; padding: 20px; text-align: center;
      font-size: 12px; color: #666666; border-top: 1px solid var(--border);
      line-height: 1.6;
    }

    .system-footer p { margin: 5px 0; }
  </style>
</head>
<body>
  <!-- Modal de Autentica√ß√£o Obrigat√≥ria -->
  <div id="authModal">
    <div class="auth-container">
      <div class="auth-header">
        <h1>üè• Archipelago Dashboard</h1>
        <p>Sistema de Gest√£o Hospitalar</p>
      </div>
      <input type="password" id="authPassword" class="auth-input" placeholder="Digite a senha (6 d√≠gitos)" maxlength="6" />
      <button id="authSubmit" class="auth-btn">ACESSAR SISTEMA</button>
      <div id="authError" class="auth-error">Senha incorreta. Tente novamente.</div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div id="loadingOverlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">Carregando dados...</div>
  </div>

  <!-- Menu Lateral -->
  <div id="side-menu">
    <button class="close-menu-btn" id="closeMenuBtn">‚úï Fechar</button>

    <div class="menu-items">
      <a href="#" class="side-menu-item active" data-tab="leitos">
        <span>Leitos</span>
      </a>
      <a href="#" class="side-menu-item" data-tab="dash-hospitalar">
        <span>Dashboard Hospitalar</span>
      </a>
      <a href="#" class="side-menu-item" data-tab="dash-executivo">
        <span>Rede Hospitalar Externa</span>
      </a>
    </div>

    <div class="menu-footer">
      <button class="settings-menu-btn" id="settingsMenuBtn">
        <span>‚öôÔ∏è</span>
        <span>Configura√ß√µes</span>
        <div class="settings-dropdown-menu" id="settingsMenuDropdown">
          <div class="settings-dropdown-item" id="btnQRCodes">Gerar QR Codes</div>
          <div class="settings-dropdown-item" id="btnAdmin">ADM</div>
        </div>
      </button>
    </div>
  </div>

  <!-- Header Principal -->
  <header>
    <div class="header-left">
      <div class="hamburger-menu" id="hamburgerMenu">‚ò∞</div>
      <div class="brand">
        <h1>Archipelago Dashboard</h1>
      </div>
    </div>
    
    <div class="header-right">
      <span id="updateTimer">Pr√≥xima atualiza√ß√£o em: 4:00</span>
      <button class="header-btn" id="refreshBtn">Atualizar</button>
    </div>
  </header>

  <!-- Main Content -->
  <main>
    <!-- VIEW: LEITOS -->
    <section id="view-leitos">
      <div class="hospital-selector">
        <button class="hospital-btn active" data-hospital="H1">Neomater</button>
        <button class="hospital-btn" data-hospital="H2">Cruz Azul</button>
        <button class="hospital-btn" data-hospital="H3">Santa Marcelina</button>
        <button class="hospital-btn" data-hospital="H4">Santa Clara</button>
      </div>
      
      <div class="grid" id="cardsContainer">
        <!-- Cards s√£o gerados dinamicamente pelo JavaScript -->
      </div>
    </section>

    <!-- VIEW: DASHBOARD HOSPITALAR -->
    <section id="view-dash-hospitalar" class="hidden">
      <h2 style="text-align: center; color: #333333; margin-bottom: 30px; font-size: 24px; text-transform: uppercase; letter-spacing: 1px;">
        Dashboard Hospitalar
      </h2>
      
      <div id="hospitais-dashboard-container">
        <!-- Dashboards por hospital gerados dinamicamente -->
      </div>
    </section>

    <!-- VIEW: DASHBOARD EXECUTIVO "REDE HOSPITALAR EXTERNA" -->
    <section id="view-dash-executivo" class="hidden">
      <h2 style="text-align: center; color: #333333; margin-bottom: 30px; font-size: 24px; text-transform: uppercase; letter-spacing: 1px;">
        Rede Hospitalar Externa
      </h2>
      
      <!-- KPIs Grid 6x2 -->
      <div class="executive-kpis-grid">
        <!-- KPI Principal (Cols 1-2, Rows 1-2) -->
        <div class="kpi-principal">
          <div class="gauge-container">
            <div style="width: 120px; height: 120px; position: relative;">
              <canvas id="gaugeExecutivo" width="120" height="120"></canvas>
              <div style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); text-align: center;">
                <div id="gaugeExecutivoText" style="font-size: 18px; font-weight: 700; color: var(--text-accent);">0%</div>
                <div style="font-size: 10px; color: var(--text-muted); text-transform: uppercase;">Ocupa√ß√£o</div>
              </div>
            </div>
            <div class="hospitais-list">
              <div class="hospital-item">
                <span class="hospital-nome">Neomater</span>
                <span class="hospital-pct" id="pct-neomater">0%</span>
              </div>
              <div class="hospital-item">
                <span class="hospital-nome">Cruz Azul</span>
                <span class="hospital-pct" id="pct-cruz-azul">0%</span>
              </div>
              <div class="hospital-item">
                <span class="hospital-nome">S.Marcelina</span>
                <span class="hospital-pct" id="pct-santa-marcelina">0%</span>
              </div>
              <div class="hospital-item">
                <span class="hospital-nome">S.Clara</span>
                <span class="hospital-pct" id="pct-santa-clara">0%</span>
              </div>
            </div>
          </div>
        </div>

        <!-- KPIs Linha 1 -->
        <div class="kpi-box">
          <div class="kpi-value" id="kpi-hospitais">4</div>
          <div class="kpi-label">Hospitais</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-value" id="kpi-total-leitos">49</div>
          <div class="kpi-label">Total de Leitos</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-value" id="kpi-ocupados">0</div>
          <div class="kpi-label">Leitos Ocupados</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-value" id="kpi-vagos">49</div>
          <div class="kpi-label">Leitos Vagos</div>
        </div>

        <!-- KPIs Linha 2 -->
        <div class="kpi-box">
          <div class="kpi-value" id="kpi-em-alta">0</div>
          <div class="kpi-label">Leitos em Alta</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-value" id="kpi-tph">0.0d</div>
          <div class="kpi-label">TPH</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-value" id="kpi-pps-medio">0%</div>
          <div class="kpi-label">PPS M√©dio</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-value" id="kpi-spict-elegivel">0%</div>
          <div class="kpi-label">SPICT-BR Eleg√≠vel</div>
        </div>
      </div>

      <!-- Gr√°ficos Executivo - LINHA COMPLETA CADA -->
      <div class="dashboard-card">
        <h3 id="analise-altas-title">An√°lise Preditiva de Altas em DD/MM/AAAA</h3>
        <div class="chart-container h-400">
          <canvas id="chartAltasExecutivo"></canvas>
        </div>
      </div>

      <div class="dashboard-card">
        <h3 id="analise-concessoes-exec-title">An√°lise Preditiva de Concess√µes em DD/MM/AAAA</h3>
        <div class="chart-container h-400">
          <canvas id="chartConcessoesExecutivo"></canvas>
        </div>
      </div>

      <div class="dashboard-card">
        <h3 id="analise-linhas-exec-title">An√°lise Preditiva de Linha de Cuidados em DD/MM/AAAA</h3>
        <div class="chart-container h-400">
          <canvas id="chartLinhasExecutivo"></canvas>
        </div>
      </div>
    </section>

    <!-- Rodap√© do Sistema -->
    <div class="system-footer">
      <p>Sistema em vers√£o BETA - n√£o pode ser usado como √∫nica fonte de refer√™ncia</p>
      <p>Para decis√µes cr√≠ticas, consulte sempre fontes adicionais e profissionais qualificados</p>
      <p><strong>Desenvolvido por: Alessandro Rodrigues - Vers√£o B1.0 - Setembro/2025</strong></p>
    </div>
  </main>

  <!-- MODAIS -->

  <!-- Modal ADM -->
  <div id="modalADM" class="backdrop">
    <div class="modal" style="max-width: 500px;">
      <header>
        <strong>√Årea Administrativa</strong>
        <span class="close-modal" data-modal="modalADM">√ó</span>
      </header>
      <div class="content">
        <div style="text-align: center; margin-bottom: 20px;">
          <h4 style="color: var(--text-accent); margin: 0;">Login Administrativo</h4>
          <p style="color: var(--text-muted); margin: 10px 0 0 0; font-size: 12px;">
            Acesso restrito para configura√ß√µes do sistema
          </p>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
          <div>
            <label style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px; display: block; font-weight: 600;">Email</label>
            <input type="email" id="admEmail" style="width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 12px; background: var(--card); color: var(--text);" placeholder="admin@email.com" />
          </div>
          <div>
            <label style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px; display: block; font-weight: 600;">Senha</label>
            <input type="password" id="admPassword" style="width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 12px; background: var(--card); color: var(--text);" placeholder="Senha..." />
          </div>
        </div>
        <div id="admError" style="color: #dc2626; font-size: 12px; margin-top: 10px; display: none;">
          Credenciais incorretas.
        </div>
      </div>
      <div class="actions">
        <button class="btn" onclick="closeModal('modalADM')">Cancelar</button>
        <button id="admLogin" class="btn primary">Entrar</button>
      </div>
    </div>
  </div>

  <!-- Modal QR Codes -->
  <div id="modalBulkQR" class="backdrop">
    <div class="modal">
      <header>
        <strong>Gerar QR Codes dos Leitos</strong>
        <span class="close-modal" data-modal="modalBulkQR">√ó</span>
      </header>
      <div class="content">
        <div style="display: flex; gap: 10px; margin-bottom: 20px; justify-content: center;">
          <select id="qrHospitalSelect" style="width: 200px; padding: 10px 12px; border: 1px solid var(--border); border-radius: 12px; background: var(--card); color: var(--text);">
            <option value="">Todos os Hospitais</option>
            <option value="H1">Neomater</option>
            <option value="H2">Cruz Azul</option>
            <option value="H3">Santa Marcelina</option>
            <option value="H4">Santa Clara</option>
          </select>
          <button id="generateBulkQR" class="btn primary">Gerar QR Codes</button>
          <button id="printQRCodes" class="btn">Imprimir</button>
        </div>
        <div id="qr_grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; padding: 20px;">
          <!-- QR Codes gerados dinamicamente -->
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Admiss√£o/Atualiza√ß√£o -->
  <div id="modalForm" class="backdrop">
    <div class="modal">
      <header>
        <strong id="modalTitle">Formul√°rio</strong>
        <span class="close-modal" data-modal="modalForm">√ó</span>
      </header>
      <div class="content">
        <!-- LINHA 1: Iniciais / Matr√≠cula / Idade -->
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 15px;">
          <div>
            <label style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px; display: block; font-weight: 600;">Iniciais</label>
            <input type="text" id="formIniciais" style="width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 12px; background: var(--card); color: var(--text);" placeholder="Ex: J.S." />
          </div>
          <div>
            <label style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px; display: block; font-weight: 600;">Matr√≠cula</label>
            <input type="text" id="formMatricula" style="width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 12px; background: var(--card); color: var(--text);" placeholder="Ex: 123456-7" />
          </div>
          <div>
            <label style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px; display: block; font-weight: 600;">Idade</label>
            <input type="number" id="formIdade" style="width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 12px; background: var(--card); color: var(--text);" placeholder="Ex: 65" min="0" max="120" />
          </div>
        </div>

        <!-- LINHA 2: PPS / SPICT-BR / Previs√£o Alta -->
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 15px;">
          <div>
            <label style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px; display: block; font-weight: 600;">PPS</label>
            <select id="formPPS" style="width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 12px; background: var(--card); color: var(--text);">
              <option value="">Selecione</option>
              <option value="10%">10%</option>
              <option value="20%">20%</option>
              <option value="30%">30%</option>
              <option value="40%">40%</option>
              <option value="50%">50%</option>
              <option value="60%">60%</option>
              <option value="70%">70%</option>
              <option value="80%">80%</option>
              <option value="90%">90%</option>
              <option value="100%">100%</option>
            </select>
          </div>
          <div>
            <label style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px; display: block; font-weight: 600;">SPICT-BR</label>
            <select id="formSPICT" style="width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 12px; background: var(--card); color: var(--text);">
              <option value="">Selecione</option>
              <option value="Eleg√≠vel">Eleg√≠vel</option>
              <option value="N√£o eleg√≠vel">N√£o eleg√≠vel</option>
            </select>
          </div>
          <div>
            <label style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px; display: block; font-weight: 600;">Previs√£o de Alta</label>
            <select id="formPrevAlta" style="width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 12px; background: var(--card); color: var(--text);">
              <option value="">Selecione</option>
              <option value="Hoje Ouro">Hoje Ouro</option>
              <option value="Hoje 2R">Hoje 2R</option>
              <option value="Hoje 3R">Hoje 3R</option>
              <option value="24h Ouro">24h Ouro</option>
              <option value="24h 2R">24h 2R</option>
              <option value="24h 3R">24h 3R</option>
              <option value="48h">48h</option>
              <option value="72h">72h</option>
              <option value="96h">96h</option>
              <option value="SP">SP</option>
            </select>
          </div>
        </div>

        <!-- CONCESS√ïES PREVISTAS NA ALTA -->
        <div style="margin-top: 20px;">
          <h4 style="color: var(--text-accent); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px;">
            Concess√µes Previstas na Alta
          </h4>
          <div id="concessoesList" style="display: grid; grid-template-columns: 1fr; gap: 8px; max-height: 200px; overflow-y: auto; border: 1px solid var(--border); border-radius: 12px; padding: 15px; background: rgba(96, 165, 250, 0.05);">
            <label style="display: flex; align-items: center; gap: 8px; color: var(--text); cursor: pointer;">
              <input type="checkbox" name="concessoes" value="Transi√ß√£o Domiciliar"> Transi√ß√£o Domiciliar
            </label>
            <label style="display: flex; align-items: center; gap: 8px; color: var(--text); cursor: pointer;">
              <input type="checkbox" name="concessoes" value="Aplica√ß√£o domiciliar de medicamentos"> Aplica√ß√£o domiciliar de medicamentos
            </label>
            <label style="display: flex; align-items: center; gap: 8px; color: var(--text); cursor: pointer;">
              <input type="checkbox" name="concessoes" value="Fisioterapia"> Fisioterapia
            </label>
            <label style="display: flex; align-items: center; gap: 8px; color: var(--text); cursor: pointer;">
              <input type="checkbox" name="concessoes" value="Fonoaudiologia"> Fonoaudiologia
            </label>
            <label style="display: flex; align-items: center; gap: 8px; color: var(--text); cursor: pointer;">
              <input type="checkbox" name="concessoes" value="Aspira√ß√£o"> Aspira√ß√£o
            </label>
            <label style="display: flex; align-items: center; gap: 8px; color: var(--text); cursor: pointer;">
              <input type="checkbox" name="concessoes" value="Banho"> Banho
            </label>
            <label style="display: flex; align-items: center; gap: 8px; color: var(--text); cursor: pointer;">
              <input type="checkbox" name="concessoes" value="Curativos"> Curativos
            </label>
            <label style="display: flex; align-items: center; gap: 8px; color: var(--text); cursor: pointer;">
              <input type="checkbox" name="concessoes" value="Oxigenoterapia"> Oxigenoterapia
            </label>
            <label style="display: flex; align-items: center; gap: 8px; color: var(--text); cursor: pointer;">
              <input type="checkbox" name="concessoes" value="Recarga de O2"> Recarga de O2
            </label>
            <label style="display: flex; align-items: center; gap: 8px; color: var(--text); cursor: pointer;">
              <input type="checkbox" name="concessoes" value="Orienta√ß√£o Nutricional - com dispositivo"> Orienta√ß√£o Nutricional - com dispositivo
            </label>
            <label style="display: flex; align-items: center; gap: 8px; color: var(--text); cursor: pointer;">
              <input type="checkbox" name="concessoes" value="Orienta√ß√£o Nutricional - sem dispositivo"> Orienta√ß√£o Nutricional - sem dispositivo
            </label>
            <label style="display: flex; align-items: center; gap: 8px; color: var(--text); cursor: pointer;">
              <input type="checkbox" name="concessoes" value="Clister"> Clister
            </label>
            <label style="display: flex; align-items: center; gap: 8px; color: var(--text); cursor: pointer;">
              <input type="checkbox" name="concessoes" value="PICC"> PICC
            </label>
          </div>
        </div>

        <!-- LINHA DE CUIDADOS PROPOSTA NA ALTA -->
        <div style="margin-top: 20px;">
          <h4 style="color: var(--text-accent); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px;">
            Linha de Cuidados Proposta na Alta
          </h4>
          <div id="linhasList" style="display: grid; grid-template-columns: 1fr; gap: 8px; max-height: 200px; overflow-y: auto; border: 1px solid var(--border); border-radius: 12px; padding: 15px; background: rgba(96, 165, 250, 0.05);">
            <label style="display: flex; align-items: center; gap: 8px; color: var(--text); cursor: pointer;">
              <input type="checkbox" name="linhas" value="Assiste"> Assiste
            </label>
            <label style="display: flex; align-items: center; gap: 8px; color: var(--text); cursor: pointer;">
              <input type="checkbox" name="linhas" value="APS"> APS
            </label>
            <label style="display: flex; align-items: center; gap: 8px; color: var(--text); cursor: pointer;">
              <input type="checkbox" name="linhas" value="Cuidados Paliativos"> Cuidados Paliativos
            </label>
            <label style="display: flex; align-items: center; gap: 8px; color: var(--text); cursor: pointer;">
              <input type="checkbox" name="linhas" value="ICO (Insufici√™ncia Coronariana)"> ICO (Insufici√™ncia Coronariana)
            </label>
            <label style="display: flex; align-items: center; gap: 8px; color: var(--text); cursor: pointer;">
              <input type="checkbox" name="linhas" value="Oncologia"> Oncologia
            </label>
            <label style="display: flex; align-items: center; gap: 8px; color: var(--text); cursor: pointer;">
              <input type="checkbox" name="linhas" value="Pediatria"> Pediatria
            </label>
            <label style="display: flex; align-items: center; gap: 8px; color: var(--text); cursor: pointer;">
              <input type="checkbox" name="linhas" value="Programa Autoimune - Gastroenterologia"> Programa Autoimune - Gastroenterologia
            </label>
            <label style="display: flex; align-items: center; gap: 8px; color: var(--text); cursor: pointer;">
              <input type="checkbox" name="linhas" value="Programa Autoimune - Neuro-desmielinizante"> Programa Autoimune - Neuro-desmielinizante
            </label>
            <label style="display: flex; align-items: center; gap: 8px; color: var(--text); cursor: pointer;">
              <input type="checkbox" name="linhas" value="Programa Autoimune - Neuro-muscular"> Programa Autoimune - Neuro-muscular
            </label>
            <label style="display: flex; align-items: center; gap: 8px; color: var(--text); cursor: pointer;">
              <input type="checkbox" name="linhas" value="Programa Autoimune - Reumatologia"> Programa Autoimune - Reumatologia
            </label>
            <label style="display: flex; align-items: center; gap: 8px; color: var(--text); cursor: pointer;">
              <input type="checkbox" name="linhas" value="Vida Mais Leve Care"> Vida Mais Leve Care
            </label>
            <label style="display: flex; align-items: center; gap: 8px; color: var(--text); cursor: pointer;">
              <input type="checkbox" name="linhas" value="Cr√¥nicos - Cardiologia"> Cr√¥nicos - Cardiologia
            </label>
            <label style="display: flex; align-items: center; gap: 8px; color: var(--text); cursor: pointer;">
              <input type="checkbox" name="linhas" value="Cr√¥nicos - Endocrinologia"> Cr√¥nicos - Endocrinologia
            </label>
            <label style="display: flex; align-items: center; gap: 8px; color: var(--text); cursor: pointer;">
              <input type="checkbox" name="linhas" value="Cr√¥nicos - Geriatria"> Cr√¥nicos - Geriatria
            </label>
            <label style="display: flex; align-items: center; gap: 8px; color: var(--text); cursor: pointer;">
              <input type="checkbox" name="linhas" value="Cr√¥nicos - Melhor Cuidado"> Cr√¥nicos - Melhor Cuidado
            </label>
            <label style="display: flex; align-items: center; gap: 8px; color: var(--text); cursor: pointer;">
              <input type="checkbox" name="linhas" value="Cr√¥nicos - Neurologia"> Cr√¥nicos - Neurologia
            </label>
            <label style="display: flex; align-items: center; gap: 8px; color: var(--text); cursor: pointer;">
              <input type="checkbox" name="linhas" value="Cr√¥nicos - Pneumologia"> Cr√¥nicos - Pneumologia
            </label>
            <label style="display: flex; align-items: center; gap: 8px; color: var(--text); cursor: pointer;">
              <input type="checkbox" name="linhas" value="Cr√¥nicos - P√≥s-bari√°trica"> Cr√¥nicos - P√≥s-bari√°trica
            </label>
            <label style="display: flex; align-items: center; gap: 8px; color: var(--text); cursor: pointer;">
              <input type="checkbox" name="linhas" value="Cr√¥nicos - Reumatologia"> Cr√¥nicos - Reumatologia
            </label>
          </div>
        </div>
      </div>
      <div class="actions">
        <button class="btn" onclick="closeModal('modalForm')">Cancelar</button>
        <button id="formSave" class="btn primary">Salvar</button>
        <button id="formDischarge" class="btn danger" style="display: none;">Dar Alta</button>
      </div>
    </div>
  </div>

  <!-- Success Message -->
  <div id="successMessage" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 3000; background: var(--gradient-card); border: 1px solid var(--border); border-radius: 20px; padding: 40px; text-align: center; color: var(--text);">
    <h2 style="color: var(--text-accent); font-weight: 700;">‚úì Sucesso!</h2>
    <p id="successText">Opera√ß√£o realizada com sucesso.</p>
  </div>
  <script>
// =================== CONFIGURA√á√ïES GLOBAIS =================== 
const CONFIG = {
  API_URL: 'https://script.google.com/macros/s/AKfycbzi8YS8acCErJvedwtx6lVr2Wd_VDOfUMsOO1xXM9MNZdedzulMmZZCMHkvI6z99AWJ/exec',
  AUTH_PASSWORD: '170284', // Senha principal (6 d√≠gitos)
  ADM_EMAIL: 'cvcalessandro@gmail.com',
  ADM_PASSWORD: 'Bruno2305!@!@', // Senha ADM conforme manual
  REFRESH_INTERVAL: 240000, // 4 minutos (240.000ms)
  QR_SESSION_TIMEOUT: 120000, // 2 minutos (120.000ms)
  HOSPITAIS_CONFIG: {
    'H1': { nome: 'Neomater', leitos: 13, cor: '#ffffff' },
    'H2': { nome: 'Cruz Azul', leitos: 16, cor: '#60a5fa' },
    'H3': { nome: 'Santa Marcelina', leitos: 7, cor: '#8b5cf6' },
    'H4': { nome: 'Santa Clara', leitos: 13, cor: '#f59e0b' }
  }
};

// =================== MAPEAMENTOS DE CORES PANTONE ===================
const CORES_CONCESSOES = {
  "Transi√ß√£o Domiciliar": "#007A53",
  "Aplica√ß√£o domiciliar de medicamentos": "#582C83",
  "Fisioterapia": "#009639",
  "Fonoaudiologia": "#FF671F",
  "Aspira√ß√£o": "#2E1A47",
  "Banho": "#8FD3F4",
  "Curativos": "#00BFB3",
  "Oxigenoterapia": "#64A70B",
  "Recarga de O2": "#00AEEF",
  "Orienta√ß√£o Nutricional - com dispositivo": "#FFC72C",
  "Orienta√ß√£o Nutricional - sem dispositivo": "#F4E285",
  "Clister": "#E8927C",
  "PICC": "#E03C31"
};

const CORES_LINHAS = {
  "Assiste": "#ED0A72",
  "APS": "#007A33",
  "Cuidados Paliativos": "#00B5A2",
  "ICO (Insufici√™ncia Coronariana)": "#A6192E",
  "Oncologia": "#6A1B9A",
  "Pediatria": "#5A646B",
  "Programa Autoimune - Gastroenterologia": "#5C5EBE",
  "Programa Autoimune - Neuro-desmielinizante": "#00AEEF",
  "Programa Autoimune - Neuro-muscular": "#00263A",
  "Programa Autoimune - Reumatologia": "#582D40",
  "Vida Mais Leve Care": "#FFB81C",
  "Cr√¥nicos - Cardiologia": "#C8102E",
  "Cr√¥nicos - Endocrinologia": "#582C83",
  "Cr√¥nicos - Geriatria": "#FF6F1D",
  "Cr√¥nicos - Melhor Cuidado": "#556F44",
  "Cr√¥nicos - Neurologia": "#0072CE",
  "Cr√¥nicos - Pneumologia": "#E35205",
  "Cr√¥nicos - P√≥s-bari√°trica": "#003C57",
  "Cr√¥nicos - Reumatologia": "#5A0020"
};

const CORES_HOSPITAIS = {
  "Neomater": "#ffffff",
  "Cruz Azul": "#60a5fa",
  "Santa Marcelina": "#8b5cf6",
  "Santa Clara": "#f59e0b"
};

const CORES_TIMELINE = {
  "Hoje Ouro": "#fbbf24",
  "Hoje 2R": "#3b82f6",
  "Hoje 3R": "#8b5cf6",
  "24h Ouro": "#fbbf24",
  "24h 2R": "#3b82f6", 
  "24h 3R": "#8b5cf6",
  "48h": "#10b981",
  "72h": "#f59e0b",
  "96h": "#ef4444",
  "SP": "#6b7280"
};

// =================== VARI√ÅVEIS GLOBAIS =================== 
let leitosData = [];
let currentHospital = 'H1';
let currentView = 'leitos';
let refreshTimer;
let lastUpdateTime = null;
let isQRMode = false;
let qrSessionTimer = null;
let qrTimeLeft = 120;
let currentLeitoQR = null;
let chartInstances = {};
let isAuthenticated = false;

// =================== LISTAS CONFORME MANUAL ===================
const CONCESSOES = [
  "Transi√ß√£o Domiciliar", "Aplica√ß√£o domiciliar de medicamentos", "Fisioterapia",
  "Fonoaudiologia", "Aspira√ß√£o", "Banho", "Curativos", "Oxigenoterapia",
  "Recarga de O2", "Orienta√ß√£o Nutricional - com dispositivo", 
  "Orienta√ß√£o Nutricional - sem dispositivo", "Clister", "PICC"
];

const LINHAS_CUIDADO = [
  "Assiste", "APS", "Cuidados Paliativos", "ICO (Insufici√™ncia Coronariana)",
  "Oncologia", "Pediatria", "Programa Autoimune - Gastroenterologia",
  "Programa Autoimune - Neuro-desmielinizante", "Programa Autoimune - Neuro-muscular",
  "Programa Autoimune - Reumatologia", "Vida Mais Leve Care", "Cr√¥nicos - Cardiologia",
  "Cr√¥nicos - Endocrinologia", "Cr√¥nicos - Geriatria", "Cr√¥nicos - Melhor Cuidado",
  "Cr√¥nicos - Neurologia", "Cr√¥nicos - Pneumologia", "Cr√¥nicos - P√≥s-bari√°trica",
  "Cr√¥nicos - Reumatologia"
];

const PPS_OPTIONS = ['10%', '20%', '30%', '40%', '50%', '60%', '70%', '80%', '90%', '100%'];

const PREVISAO_ALTA_OPTIONS = [
  'Hoje Ouro', 'Hoje 2R', 'Hoje 3R', '24h Ouro', '24h 2R', '24h 3R', 
  '48h', '72h', '96h', 'SP'
];

// =================== FUN√á√ïES UTILIT√ÅRIAS ===================
function logInfo(message, data = null) { console.log(`üîµ [Archipelago] ${message}`, data || ''); }
function logSuccess(message, data = null) { console.log(`üü¢ [SUCCESS] ${message}`, data || ''); }
function logError(message, error = null) { console.error(`üî¥ [ERROR] ${message}`, error || ''); }

function gerarIniciais(nome) {
  if (!nome) return '‚Äî';
  const palavras = nome.split(' ').filter(p => p.length > 1);
  return palavras.slice(0, 3).map(p => p[0].toUpperCase()).join('.');
}

function formatarDataHora(iso) {
  if (!iso) return '‚Äî';
  const d = new Date(iso);
  return d.toLocaleString('pt-BR', { 
    day: '2-digit', month: '2-digit', year: 'numeric', 
    hour: '2-digit', minute: '2-digit' 
  });
}

function calcularTempoInternacao(iso) {
  if (!iso) return { text: '‚Äî', days: 0 };
  const ms = Date.now() - new Date(iso).getTime();
  const days = Math.floor(ms / 86400000);
  const hours = Math.floor((ms % 86400000) / 3600000);
  return { text: `${days}d ${hours}h`, days: days };
}

// =================== SISTEMA DE AUTENTICA√á√ÉO ===================
function initAuthentication() {
  if (localStorage.getItem('archipelago_auth') === 'true') {
    hideAuthModal();
    return;
  }

  const authModal = document.getElementById('authModal');
  const authPassword = document.getElementById('authPassword');
  const authSubmit = document.getElementById('authSubmit');
  const authError = document.getElementById('authError');

  authModal.style.display = 'flex';

  authSubmit.addEventListener('click', authenticate);
  authPassword.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') authenticate();
  });

  function authenticate() {
    const password = authPassword.value.trim();
    
    if (password === CONFIG.AUTH_PASSWORD) {
      localStorage.setItem('archipelago_auth', 'true');
      isAuthenticated = true;
      hideAuthModal();
      initializeSystem();
    } else {
      authError.classList.add('show');
      authPassword.value = '';
      authPassword.focus();
      setTimeout(() => {
        authError.classList.remove('show');
      }, 2000);
    }
  }

  function hideAuthModal() {
    authModal.style.opacity = '0';
    setTimeout(() => {
      authModal.style.display = 'none';
    }, 300);
  }
}

// =================== CARREGAMENTO DE DADOS ===================
async function loadData() {
  logInfo('Carregando dados...');
  
  try {
    showLoading();
    
    // Simular dados para os 4 hospitais
    Object.keys(CONFIG.HOSPITAIS_CONFIG).forEach(hospitalId => {
      const hospital = CONFIG.HOSPITAIS_CONFIG[hospitalId];
      const dados = [];
      
      for (let i = 1; i <= hospital.leitos; i++) {
        const isOcupado = Math.random() > 0.4;
        
        if (isOcupado) {
          dados.push({
            hospital: hospitalId,
            leito: i,
            tipo: i > 10 ? 'UTI' : 'ENF/APTO',
            status: 'Em uso',
            nome: `Paciente ${hospitalId}-${i}`,
            matricula: `${hospitalId}${String(i).padStart(6, '0')}`,
            idade: 45 + (i * 7) % 40,
            admAt: new Date(Date.now() - (i * 24 * 60 * 60 * 1000)).toISOString(),
            pps: PPS_OPTIONS[i % PPS_OPTIONS.length],
            spict: i % 2 === 0 ? 'Eleg√≠vel' : 'N√£o eleg√≠vel',
            prevAlta: PREVISAO_ALTA_OPTIONS[i % PREVISAO_ALTA_OPTIONS.length],
            linhas: LINHAS_CUIDADO.slice(0, Math.max(1, (i % 4))),
            concessoes: CONCESSOES.slice(0, Math.max(1, (i % 3)))
          });
        } else {
          dados.push({
            hospital: hospitalId,
            leito: i,
            tipo: i > 10 ? 'UTI' : 'ENF/APTO',
            status: 'Vago',
            nome: null,
            matricula: null,
            idade: null,
            admAt: null,
            pps: null,
            spict: null,
            prevAlta: null,
            linhas: [],
            concessoes: []
          });
        }
      }
      
      // Adicionar ao array global baseado no hospital atual
      if (hospitalId === currentHospital) {
        leitosData = dados;
      }
    });
    
    lastUpdateTime = new Date();
    updateLastUpdateInfo();
    hideLoading();
    
    if (currentView === 'leitos') {
      renderCards();
    } else if (currentView === 'dash-hospitalar') {
      renderDashboardHospitalar();
    } else if (currentView === 'dash-executivo') {
      renderDashboardExecutivo();
    }
    
    logSuccess('Dados carregados com sucesso');
  } catch (error) {
    logError('Erro ao carregar dados:', error);
    hideLoading();
  }
}

// =================== RENDERIZA√á√ÉO DE CARDS ===================
function renderCards() {
  const container = document.getElementById('cardsContainer');
  if (!container) return;
  
  container.innerHTML = '';
  
  if (leitosData.length === 0) {
    container.innerHTML = `
      <div class="card" style="grid-column: 1 / -1; text-align: center; padding: 40px;">
        <h3 style="color: var(--text-accent); margin: 0 0 10px 0;">Carregando dados...</h3>
        <p style="color: var(--text-white); margin: 0;">Hospital: ${CONFIG.HOSPITAIS_CONFIG[currentHospital]?.nome}</p>
      </div>
    `;
    return;
  }

  leitosData.forEach(l => {
    const card = document.createElement('div');
    card.className = 'card';

    // Layout 3x3 conforme manual
    card.innerHTML = `
      <!-- LINHA 1: Hospital / Leito / Tipo -->
      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 12px;">
        <div style="background: rgba(255, 255, 255, 0.08); border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 8px; padding: 10px; min-height: 40px; display: flex; flex-direction: column; justify-content: center;">
          <div style="font-size: 10px; color: rgba(255, 255, 255, 0.7); font-weight: 600; text-transform: uppercase; margin-bottom: 3px;">Hospital</div>
          <div style="color: #ffffff; font-weight: 600; font-size: 12px;">${CONFIG.HOSPITAIS_CONFIG[l.hospital]?.nome || 'Hospital'}</div>
        </div>
        
        <div style="min-height: 40px; display: flex; align-items: center; justify-content: center;">
          <div class="leito-badge ${l.status === 'Vago' ? '' : 'ocupado'}" style="width: 100%;">
            LEITO ${l.leito}
          </div>
        </div>
        
        <div style="background: rgba(255, 255, 255, 0.08); border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 8px; padding: 10px; min-height: 40px; display: flex; flex-direction: column; justify-content: center;">
          <div style="font-size: 10px; color: rgba(255, 255, 255, 0.7); font-weight: 600; text-transform: uppercase; margin-bottom: 3px;">Tipo</div>
          <div style="color: #ffffff; font-weight: 600; font-size: 12px;">${l.tipo}</div>
        </div>
      </div>

      <!-- LINHA 2: Iniciais / Matr√≠cula / Idade -->
      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 12px;">
        <div style="background: rgba(255, 255, 255, 0.08); border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 8px; padding: 10px;">
          <div style="font-size: 10px; color: rgba(255, 255, 255, 0.7); font-weight: 600; text-transform: uppercase; margin-bottom: 3px;">Iniciais</div>
          <div style="color: #ffffff; font-weight: 600; font-size: 12px;">${l.status === 'Em uso' ? gerarIniciais(l.nome) : '‚Äî'}</div>
        </div>
        
        <div style="background: rgba(255, 255, 255, 0.08); border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 8px; padding: 10px;">
          <div style="font-size: 10px; color: rgba(255, 255, 255, 0.7); font-weight: 600; text-transform: uppercase; margin-bottom: 3px;">Matr√≠cula</div>
          <div style="color: #ffffff; font-weight: 600; font-size: 12px;">${l.matricula || '‚Äî'}</div>
        </div>
        
        <div style="background: rgba(255, 255, 255, 0.08); border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 8px; padding: 10px;">
          <div style="font-size: 10px; color: rgba(255, 255, 255, 0.7); font-weight: 600; text-transform: uppercase; margin-bottom: 3px;">Idade</div>
          <div style="color: #ffffff; font-weight: 600; font-size: 12px;">${l.idade ? l.idade + ' anos' : '‚Äî'}</div>
        </div>
      </div>

      <!-- LINHA 3: PPS / SPICT-BR / Previs√£o de Alta -->
      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px;">
        <div style="background: rgba(255, 255, 255, 0.08); border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 8px; padding: 10px;">
          <div style="font-size: 10px; color: rgba(255, 255, 255, 0.7); font-weight: 600; text-transform: uppercase; margin-bottom: 3px;">PPS</div>
          <div style="color: #ffffff; font-weight: 600; font-size: 12px;">${l.pps || '‚Äî'}</div>
        </div>
        
        <div style="background: rgba(255, 255, 255, 0.08); border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 8px; padding: 10px;">
          <div style="font-size: 10px; color: rgba(255, 255, 255, 0.7); font-weight: 600; text-transform: uppercase; margin-bottom: 3px;">SPICT-BR</div>
          <div style="color: #ffffff; font-weight: 600; font-size: 12px;">${l.spict || '‚Äî'}</div>
        </div>
        
        <div style="background: var(--destaque); border: 1px solid rgba(143, 211, 244, 0.5); border-radius: 8px; padding: 10px;">
          <div style="font-size: 10px; color: #000000; font-weight: 700; text-transform: uppercase; margin-bottom: 3px;">Prev. Alta</div>
          <div style="color: #000000; font-weight: 700; font-size: 12px;">${l.prevAlta || '‚Äî'}</div>
        </div>
      </div>

      <!-- LINHA 4: CONCESS√ïES PREVISTAS NA ALTA -->
      <div style="margin-bottom: 15px;">
        <div class="section-title">CONCESS√ïES PREVISTAS NA ALTA</div>
        <div style="display: flex; flex-wrap: wrap; gap: 4px; min-height: 24px; background: rgba(255, 255, 255, 0.05); border-radius: 6px; padding: 8px;">
          ${(l.concessoes || []).map(c => `<span class="chip-item">${c}</span>`).join('') || '<span style="color: rgba(255, 255, 255, 0.7); font-size: 10px;">Nenhuma</span>'}
        </div>
      </div>

      <!-- LINHA 5: LINHA DE CUIDADOS PROPOSTA NA ALTA -->
      <div style="margin-bottom: 15px;">
        <div class="section-title">LINHA DE CUIDADOS PROPOSTA NA ALTA</div>
        <div style="display: flex; flex-wrap: wrap; gap: 4px; min-height: 24px; background: rgba(255, 255, 255, 0.05); border-radius: 6px; padding: 8px;">
          ${(l.linhas || []).map(linha => `<span class="chip-item">${linha}</span>`).join('') || '<span style="color: rgba(255, 255, 255, 0.7); font-size: 10px;">Nenhuma</span>'}
        </div>
      </div>

      <!-- LINHA 6: ADMISS√ÉO + BOT√ïES -->
      <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 12px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
        <div style="flex: 1; display: flex; gap: 20px;">
          <div>
            <div style="font-size: 10px; color: rgba(255, 255, 255, 0.7); font-weight: 600; text-transform: uppercase; margin-bottom: 3px;">Admiss√£o</div>
            <div style="color: #ffffff; font-weight: 600; font-size: 11px;">${l.admAt ? formatarDataHora(l.admAt) : '‚Äî'}</div>
          </div>
          ${l.status === 'Em uso' ? `
          <div>
            <div style="font-size: 10px; color: rgba(255, 255, 255, 0.7); font-weight: 600; text-transform: uppercase; margin-bottom: 3px;">Internado h√°</div>
            <div style="color: #ffffff; font-weight: 600; font-size: 11px;">${calcularTempoInternacao(l.admAt).text}</div>
          </div>
          ` : ''}
        </div>
        
        <div style="display: flex; gap: 8px;">
          ${l.status === 'Vago'
            ? `<button class="btn primary" onclick="openForm('${l.hospital}', ${l.leito}, true)">Admitir</button>`
            : `<button class="btn primary" onclick="openForm('${l.hospital}', ${l.leito}, false)">Atualizar</button>`
          }
        </div>
      </div>
    `;

    container.appendChild(card);
  });
}

// =================== SISTEMA DE NAVEGA√á√ÉO ===================
function switchView(view) {
  logInfo(`Mudando para view: ${view}`);
  
  const views = ['view-leitos', 'view-dash-hospitalar', 'view-dash-executivo'];
  views.forEach(v => {
    const element = document.getElementById(v);
    if (element) {
      element.classList.add('hidden');
    }
  });
  
  const targetView = document.getElementById(`view-${view}`);
  if (targetView) {
    targetView.classList.remove('hidden');
  }
  
  currentView = view;
  
  if (view === 'leitos') {
    renderCards();
  } else if (view === 'dash-hospitalar') {
    renderDashboardHospitalar();
  } else if (view === 'dash-executivo') {
    renderDashboardExecutivo();
  }
}

function setHospital(hospitalId) {
  if (!CONFIG.HOSPITAIS_CONFIG[hospitalId]) return;
  
  currentHospital = hospitalId;
  
  document.querySelectorAll('.hospital-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  
  const activeBtn = document.querySelector(`[data-hospital="${hospitalId}"]`);
  if (activeBtn) {
    activeBtn.classList.add('active');
  }
  
  loadData(); // Recarregar dados para o hospital selecionado
  
  logInfo(`Hospital selecionado: ${CONFIG.HOSPITAIS_CONFIG[hospitalId].nome}`);
}

// =================== TIMER DE ATUALIZA√á√ÉO ===================
function startRefreshTimer() {
  if (refreshTimer) clearInterval(refreshTimer);
  
  let timeLeft = CONFIG.REFRESH_INTERVAL / 1000; // 4 minutos em segundos
  
  refreshTimer = setInterval(() => {
    timeLeft--;
    updateTimerDisplay(timeLeft);
    
    if (timeLeft <= 0) {
      if (!isQRMode && currentView === 'leitos') {
        loadData();
      }
      timeLeft = CONFIG.REFRESH_INTERVAL / 1000;
    }
  }, 1000);
}

function updateTimerDisplay(seconds) {
  const minutes = Math.floor(seconds / 60);
  const remainingSeconds = seconds % 60;
  const display = `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
  
  const timerEl = document.getElementById('updateTimer');
  if (timerEl) {
    timerEl.textContent = `Pr√≥xima atualiza√ß√£o em: ${display}`;
  }
}

function updateLastUpdateInfo() {
  if (lastUpdateTime) {
    const timeString = lastUpdateTime.toLocaleTimeString('pt-BR');
    logSuccess(`√öltima atualiza√ß√£o: ${timeString}`);
  }
}

// =================== FUN√á√ïES UTILIT√ÅRIAS ===================
function showLoading() {
  const overlay = document.getElementById('loadingOverlay');
  if (overlay) {
    overlay.style.display = 'flex';
  }
}

function hideLoading() {
  const overlay = document.getElementById('loadingOverlay');
  if (overlay) {
    setTimeout(() => {
      overlay.style.display = 'none';
    }, 500);
  }
}

function showModal(modalId) {
  const modal = document.getElementById(modalId);
  if (modal) {
    modal.style.display = 'flex';
  }
}

function closeModal(modalId) {
  const modal = document.getElementById(modalId);
  if (modal) {
    modal.style.display = 'none';
  }
}

function showSuccessMessage(message = 'Opera√ß√£o realizada com sucesso!') {
  const successEl = document.getElementById('successMessage');
  const textEl = document.getElementById('successText');
  
  if (successEl && textEl) {
    textEl.textContent = message;
    successEl.style.display = 'block';
    
    setTimeout(() => {
      successEl.style.display = 'none';
    }, 3000);
  }
}

// =================== FUN√á√ïES DE FORMUL√ÅRIO ===================
function openForm(hospital, leito, isVago) {
  logInfo(`Abrindo formul√°rio: ${hospital} - Leito ${leito} - Vago: ${isVago}`);
  
  const modal = document.getElementById('modalForm');
  const title = document.getElementById('modalTitle');
  const dischargeBtn = document.getElementById('formDischarge');
  
  if (!modal) return;
  
  if (title) {
    title.textContent = isVago ? 'Admiss√£o de Paciente' : 'Atualiza√ß√£o de Paciente';
  }
  
  if (dischargeBtn) {
    dischargeBtn.style.display = isVago ? 'none' : 'inline-block';
  }
  
  // Preencher dados se for atualiza√ß√£o
  if (!isVago) {
    const leitoData = leitosData.find(l => l.hospital === hospital && l.leito == leito);
    if (leitoData) {
      fillForm(leitoData);
    }
  } else {
    clearForm();
  }
  
  // Armazenar dados do leito atual
  modal.setAttribute('data-hospital', hospital);
  modal.setAttribute('data-leito', leito);
  modal.setAttribute('data-is-vago', isVago);
  
  showModal('modalForm');
}

function fillForm(data) {
  const fields = {
    'formIniciais': data.nome ? gerarIniciais(data.nome) : '',
    'formMatricula': data.matricula || '',
    'formIdade': data.idade || '',
    'formPPS': data.pps || '',
    'formSPICT': data.spict || '',
    'formPrevAlta': data.prevAlta || ''
  };
  
  Object.entries(fields).forEach(([id, value]) => {
    const element = document.getElementById(id);
    if (element) {
      element.value = value;
    }
  });
  
  fillCheckboxes('concessoes', data.concessoes);
  fillCheckboxes('linhas', data.linhas);
}

function fillCheckboxes(name, data) {
  const checkboxes = document.querySelectorAll(`input[name="${name}"]`);
  checkboxes.forEach(cb => cb.checked = false);
  
  if (data && Array.isArray(data)) {
    data.forEach(item => {
      const checkbox = document.querySelector(`input[name="${name}"][value="${item}"]`);
      if (checkbox) {
        checkbox.checked = true;
      }
    });
  }
}

function clearForm() {
  const inputs = document.querySelectorAll('#modalForm input, #modalForm select');
  inputs.forEach(input => {
    if (input.type === 'checkbox') {
      input.checked = false;
    } else {
      input.value = '';
    }
  });
}

function saveFormData() {
  logInfo('Salvando dados do formul√°rio...');
  
  const modal = document.getElementById('modalForm');
  if (!modal) return;
  
  const hospital = modal.getAttribute('data-hospital');
  const leito = modal.getAttribute('data-leito');
  const isVago = modal.getAttribute('data-is-vago') === 'true';
  
  // Simular salvamento
  showSuccessMessage(isVago ? 'Paciente admitido com sucesso!' : 'Dados atualizados com sucesso!');
  closeModal('modalForm');
  
  setTimeout(() => {
    loadData();
  }, 1000);
}

function dischargePatient() {
  if (confirm('Tem certeza que deseja dar alta a este paciente?')) {
    logInfo('Dando alta ao paciente...');
    
    showSuccessMessage('Paciente recebeu alta com sucesso!');
    closeModal('modalForm');
    
    setTimeout(() => {
      loadData();
    }, 1000);
  }
}

function getCheckedValues(name) {
  const checkboxes = document.querySelectorAll(`input[name="${name}"]:checked`);
  return Array.from(checkboxes).map(cb => cb.value);
}

// =================== INICIALIZA√á√ÉO PRINCIPAL ===================
async function initializeSystem() {
  logSuccess('Archipelago Dashboard V3.0 - Sistema Inicializado');
  logInfo('Autentica√ß√£o aprovada - Senha 170284');
  logInfo('Timer 4 minutos configurado');
  logInfo('4 hospitais configurados:', Object.keys(CONFIG.HOSPITAIS_CONFIG).map(h => CONFIG.HOSPITAIS_CONFIG[h].nome).join(', '));
  
  initMenuSystem();
  startRefreshTimer();
  
  switchView('leitos');
  await loadData();
}

console.log("‚úÖ PARTE 3/4 CARREGADA - JAVASCRIPT PRINCIPAL COMPLETO");
</script>
<script>
// =================== DASHBOARDS E GR√ÅFICOS ===================

function renderDashboardExecutivo() {
  logInfo('Renderizando Dashboard Executivo...');
  
  updateExecutiveKPIs();
  updateExecutiveCharts();
  
  logSuccess('Dashboard Executivo renderizado');
}

function updateExecutiveKPIs() {
  const stats = calculateOverallStats();
  
  // Atualizar KPIs num√©ricos
  updateElement('kpi-hospitais', Object.keys(CONFIG.HOSPITAIS_CONFIG).length);
  updateElement('kpi-total-leitos', stats.totalLeitos);
  updateElement('kpi-ocupados', stats.ocupados);
  updateElement('kpi-vagos', stats.vagos);
  updateElement('kpi-em-alta', stats.emAlta);
  updateElement('kpi-tph', `${stats.tph}d`);
  updateElement('kpi-pps-medio', `${stats.ppsMedio}%`);
  updateElement('kpi-spict-elegivel', `${stats.spictElegivel}%`);
  
  // Atualizar percentuais por hospital
  Object.keys(CONFIG.HOSPITAIS_CONFIG).forEach(hospitalId => {
    const hospitalStats = calculateHospitalStats(hospitalId);
    const elementId = `pct-${CONFIG.HOSPITAIS_CONFIG[hospitalId].nome.toLowerCase().replace(/[^a-z0-9]/g, '-')}`;
    updateElement(elementId, `${hospitalStats.ocupacaoPercentual}%`);
  });
  
  // Atualizar gauge principal
  updateExecutiveGauge(stats.ocupacaoGeral);
}

function calculateOverallStats() {
  // Simular dados consolidados
  const totalLeitos = Object.values(CONFIG.HOSPITAIS_CONFIG).reduce((sum, config) => sum + config.leitos, 0);
  const ocupados = Math.floor(totalLeitos * 0.65); // 65% ocupa√ß√£o
  const vagos = totalLeitos - ocupados;
  const emAlta = Math.floor(ocupados * 0.15); // 15% em alta
  const ocupacaoGeral = totalLeitos > 0 ? Math.round((ocupados / totalLeitos) * 100) : 0;
  
  return {
    totalLeitos,
    ocupados,
    vagos,
    emAlta,
    ocupacaoGeral,
    tph: 3, // Tempo m√©dio 3 dias
    ppsMedio: 65, // PPS m√©dio 65%
    spictElegivel: 35 // 35% eleg√≠veis SPICT
  };
}

function calculateHospitalStats(hospitalId) {
  const config = CONFIG.HOSPITAIS_CONFIG[hospitalId];
  if (!config) return { ocupacaoPercentual: 0, ocupados: 0, vagos: 0 };
  
  const ocupados = Math.floor(config.leitos * (0.5 + Math.random() * 0.4)); // 50-90% ocupa√ß√£o
  const ocupacaoPercentual = Math.round((ocupados / config.leitos) * 100);
  
  return {
    totalLeitos: config.leitos,
    ocupados,
    vagos: config.leitos - ocupados,
    ocupacaoPercentual
  };
}

function updateExecutiveGauge(percentage) {
  const canvas = document.getElementById('gaugeExecutivo');
  const textElement = document.getElementById('gaugeExecutivoText');
  
  if (!canvas || !textElement) return;
  
  if (chartInstances.gaugeExecutivo) {
    chartInstances.gaugeExecutivo.destroy();
  }
  
  const ctx = canvas.getContext('2d');
  
  chartInstances.gaugeExecutivo = new Chart(ctx, {
    type: 'doughnut',
    data: {
      datasets: [{
        data: [percentage, 100 - percentage],
        backgroundColor: ['#60a5fa', '#334155'],
        borderWidth: 0,
        circumference: 180,
        rotation: 270
      }]
    },
    options: {
      responsive: false,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: { enabled: false }
      },
      cutout: '70%'
    }
  });
  
  textElement.textContent = `${percentage}%`;
}

function updateExecutiveCharts() {
  const hoje = new Date().toLocaleDateString('pt-BR');
  
  updateElement('analise-altas-title', `An√°lise Preditiva de Altas em ${hoje}`);
  updateElement('analise-concessoes-exec-title', `An√°lise Preditiva de Concess√µes em ${hoje}`);
  updateElement('analise-linhas-exec-title', `An√°lise Preditiva de Linha de Cuidados em ${hoje}`);
  
  renderExecutiveAltasChart();
  renderExecutiveConcessoesChart();
  renderExecutiveLinhasChart();
}

function renderExecutiveAltasChart() {
  const canvas = document.getElementById('chartAltasExecutivo');
  if (!canvas) return;
  
  if (chartInstances.altasExecutivo) {
    chartInstances.altasExecutivo.destroy();
  }
  
  const ctx = canvas.getContext('2d');
  const data = processAltasDataExecutivo();
  
  chartInstances.altasExecutivo = new Chart(ctx, {
    type: 'bar',
    data: data,
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: true,
          position: 'bottom',
          labels: {
            usePointStyle: true,
            padding: 20,
            generateLabels: (chart) => {
              return Object.keys(CONFIG.HOSPITAIS_CONFIG).map((hospitalId, index) => {
                const hospital = CONFIG.HOSPITAIS_CONFIG[hospitalId];
                return {
                  text: hospital.nome,
                  fillStyle: CORES_HOSPITAIS[hospital.nome] || '#60a5fa',
                  strokeStyle: hospital.nome === 'Neomater' ? '#0a2b52' : undefined,
                  lineWidth: hospital.nome === 'Neomater' ? 2 : 0,
                  index: index
                };
              });
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Quantidade de Benefici√°rios',
            color: '#e2e8f0'
          },
          ticks: { color: '#e2e8f0' },
          grid: { color: '#334155' }
        },
        x: {
          ticks: { color: '#e2e8f0' },
          grid: { color: '#334155' }
        }
      }
    }
  });
}

function processAltasDataExecutivo() {
  const categorias = ['Hoje Ouro', 'Hoje 2R', 'Hoje 3R', '24h Ouro', '24h 2R', '24h 3R', '48h', '72h', '96h'];
  const hospitais = Object.keys(CONFIG.HOSPITAIS_CONFIG);
  
  const datasets = hospitais.map(hospitalId => {
    const hospital = CONFIG.HOSPITAIS_CONFIG[hospitalId];
    // Simular dados de altas
    const data = categorias.map(() => Math.floor(Math.random() * 5));
    
    return {
      label: hospital.nome,
      data: data,
      backgroundColor: CORES_HOSPITAIS[hospital.nome] || '#60a5fa',
      borderColor: hospital.nome === 'Neomater' ? '#0a2b52' : undefined,
      borderWidth: hospital.nome === 'Neomater' ? 2 : 0
    };
  });
  
  return { labels: categorias, datasets: datasets };
}

function renderExecutiveConcessoesChart() {
  const canvas = document.getElementById('chartConcessoesExecutivo');
  if (!canvas) return;
  
  if (chartInstances.concessoesExecutivo) {
    chartInstances.concessoesExecutivo.destroy();
  }
  
  const ctx = canvas.getContext('2d');
  const data = processConcessoesDataExecutivo();
  
  chartInstances.concessoesExecutivo = new Chart(ctx, {
    type: 'bar',
    data: data,
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: { stacked: true, ticks: { color: '#e2e8f0' }, grid: { color: '#334155' } },
        y: { 
          stacked: true, beginAtZero: true,
          title: { display: true, text: 'Quantidade de Benefici√°rios', color: '#e2e8f0' },
          ticks: { color: '#e2e8f0' }, grid: { color: '#334155' }
        }
      },
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            usePointStyle: true,
            padding: 8,
            generateLabels: (chart) => {
              return chart.data.datasets.map((dataset, index) => ({
                text: dataset.label,
                fillStyle: dataset.backgroundColor,
                datasetIndex: index
              }));
            }
          }
        }
      }
    }
  });
}

function processConcessoesDataExecutivo() {
  const periodos = ['Hoje', '24h', '48h', '72h', '96h'];
  const concessoesUsadas = CONCESSOES.slice(0, 8); // Primeiras 8 concess√µes
  
  const datasets = concessoesUsadas.map(concessao => ({
    label: concessao,
    data: periodos.map(() => Math.floor(Math.random() * 3)),
    backgroundColor: CORES_CONCESSOES[concessao] || '#6b7280'
  }));
  
  return { labels: periodos, datasets: datasets };
}

function renderExecutiveLinhasChart() {
  const canvas = document.getElementById('chartLinhasExecutivo');
  if (!canvas) return;
  
  if (chartInstances.linhasExecutivo) {
    chartInstances.linhasExecutivo.destroy();
  }
  
  const ctx = canvas.getContext('2d');
  const data = processLinhasDataExecutivo();
  
  chartInstances.linhasExecutivo = new Chart(ctx, {
    type: 'bar',
    data: data,
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: { stacked: true, ticks: { color: '#e2e8f0' }, grid: { color: '#334155' } },
        y: { 
          stacked: true, beginAtZero: true,
          title: { display: true, text: 'Quantidade de Benefici√°rios', color: '#e2e8f0' },
          ticks: { color: '#e2e8f0' }, grid: { color: '#334155' }
        }
      },
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            usePointStyle: true,
            padding: 8,
            generateLabels: (chart) => {
              return chart.data.datasets.map((dataset, index) => ({
                text: dataset.label,
                fillStyle: dataset.backgroundColor,
                datasetIndex: index
              }));
            }
          }
        }
      }
    }
  });
}

function processLinhasDataExecutivo() {
  const periodos = ['Hoje', '24h', '48h', '72h', '96h'];
  const linhasUsadas = LINHAS_CUIDADO.slice(0, 10); // Primeiras 10 linhas
  
  const datasets = linhasUsadas.map(linha => ({
    label: linha,
    data: periodos.map(() => Math.floor(Math.random() * 3)),
    backgroundColor: CORES_LINHAS[linha] || '#6b7280'
  }));
  
  return { labels: periodos, datasets: datasets };
}

function renderDashboardHospitalar() {
  logInfo('Renderizando Dashboard Hospitalar...');
  
  const container = document.getElementById('hospitais-dashboard-container');
  if (!container) return;
  
  container.innerHTML = '';
  
  Object.keys(CONFIG.HOSPITAIS_CONFIG).forEach(hospitalId => {
    const hospitalDashboard = createHospitalDashboard(hospitalId);
    container.appendChild(hospitalDashboard);
  });
  
  logSuccess('Dashboard Hospitalar renderizado');
}

function createHospitalDashboard(hospitalId) {
  const hospital = CONFIG.HOSPITAIS_CONFIG[hospitalId];
  const stats = calculateHospitalStats(hospitalId);
  const hoje = new Date().toLocaleDateString('pt-BR');
  
  const div = document.createElement('div');
  div.className = 'dashboard-card';
  div.style.marginBottom = '30px';
  
  div.innerHTML = `
    <h3>${hospital.nome}</h3>
    
    <!-- KPIs do Hospital -->
    <div style="display: flex; align-items: center; gap: 24px; margin-bottom: 20px;">
      <div style="position: relative; width: 150px; height: 100px;">
        <canvas id="gauge-${hospitalId}" width="150" height="100"></canvas>
        <div style="position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); text-align: center;">
          <div style="font-size: 24px; font-weight: 700; color: var(--text-accent);">${stats.ocupacaoPercentual}%</div>
          <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase;">Ocupa√ß√£o</div>
        </div>
      </div>
      
      <div style="flex: 1; display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
        <div style="padding: 10px; text-align: center; background: rgba(96, 165, 250, 0.1); border-radius: 10px;">
          <div style="font-size: 22px; font-weight: bold; color: var(--text-accent);">${stats.totalLeitos}</div>
          <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase;">Total</div>
        </div>
        <div style="padding: 10px; text-align: center; background: rgba(96, 165, 250, 0.1); border-radius: 10px;">
          <div style="font-size: 22px; font-weight: bold; color: var(--text-accent);">${stats.ocupados}</div>
          <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase;">Ocupados</div>
        </div>
        <div style="padding: 10px; text-align: center; background: rgba(96, 165, 250, 0.1); border-radius: 10px;">
          <div style="font-size: 22px; font-weight: bold; color: var(--text-accent);">${stats.vagos}</div>
          <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase;">Vagos</div>
        </div>
        <div style="padding: 10px; text-align: center; background: rgba(96, 165, 250, 0.1); border-radius: 10px;">
          <div style="font-size: 22px; font-weight: bold; color: var(--text-accent);">${Math.floor(stats.ocupados * 0.2)}</div>
          <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase;">Em Alta</div>
        </div>
      </div>
    </div>

    <!-- Gr√°fico de Altas -->
    <h4 style="margin: 20px 0 10px 0; color: var(--text-white);">Proje√ß√£o de Altas em ${hoje}</h4>
    <div class="chart-container h-300">
      <canvas id="chart-altas-${hospitalId}"></canvas>
    </div>
  `;
  
  setTimeout(() => {
    renderHospitalGauge(hospitalId, stats.ocupacaoPercentual);
    renderHospitalAltasChart(hospitalId);
  }, 100);
  
  return div;
}

function renderHospitalGauge(hospitalId, percentual) {
  const canvas = document.getElementById(`gauge-${hospitalId}`);
  if (!canvas) return;

  const chartKey = `gauge-${hospitalId}`;
  if (chartInstances[chartKey]) {
    chartInstances[chartKey].destroy();
  }

  const ctx = canvas.getContext('2d');
  const hospital = CONFIG.HOSPITAIS_CONFIG[hospitalId];

  chartInstances[chartKey] = new Chart(ctx, {
    type: 'doughnut',
    data: {
      datasets: [{
        data: [percentual, 100 - percentual],
        backgroundColor: [hospital.cor, '#334155'],
        borderWidth: 0,
        circumference: 180,
        rotation: 270
      }]
    },
    options: {
      responsive: false,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: { enabled: false }
      },
      cutout: '70%'
    }
  });
}

function renderHospitalAltasChart(hospitalId) {
  const canvas = document.getElementById(`chart-altas-${hospitalId}`);
  if (!canvas) return;

  const chartKey = `altas-${hospitalId}`;
  if (chartInstances[chartKey]) {
    chartInstances[chartKey].destroy();
  }

  const ctx = canvas.getContext('2d');
  const data = processHospitalAltasData(hospitalId);

  chartInstances[chartKey] = new Chart(ctx, {
    type: 'bar',
    data: data,
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          title: { display: true, text: 'Quantidade de Benefici√°rios', color: '#e2e8f0' },
          ticks: { color: '#e2e8f0' }, grid: { color: '#334155' }
        },
        x: { ticks: { color: '#e2e8f0' }, grid: { color: '#334155' } }
      },
      plugins: { legend: { display: false } }
    }
  });
}

function processHospitalAltasData(hospitalId) {
  const categorias = ['Hoje Ouro', 'Hoje 2R', 'Hoje 3R', '24h Ouro', '24h 2R', '24h 3R', '48h', '72h', '96h', 'SP'];
  
  const valores = categorias.map(() => Math.floor(Math.random() * 4));
  const cores = categorias.map(cat => CORES_TIMELINE[cat] || '#6b7280');

  return {
    labels: categorias,
    datasets: [{
      data: valores,
      backgroundColor: cores,
      borderColor: cores
    }]
  };
}

// =================== EVENT LISTENERS E SISTEMA DE MENU ===================
function initMenuSystem() {
  const hamburgerMenu = document.getElementById('hamburgerMenu');
  const closeMenuBtn = document.getElementById('closeMenuBtn');
  const sideMenu = document.getElementById('side-menu');
  const body = document.body;

  if (hamburgerMenu) {
    hamburgerMenu.addEventListener('click', () => {
      body.classList.toggle('menu-open');
      sideMenu.classList.toggle('open');
    });
  }

  if (closeMenuBtn) {
    closeMenuBtn.addEventListener('click', () => {
      body.classList.remove('menu-open');
      sideMenu.classList.remove('open');
    });
  }

  // Menu items navigation
  document.querySelectorAll('.side-menu-item').forEach(item => {
    item.addEventListener('click', (e) => {
      e.preventDefault();
      const tab = item.dataset.tab;
      
      // Update active state
      document.querySelectorAll('.side-menu-item').forEach(mi => mi.classList.remove('active'));
      item.classList.add('active');
      
      // Switch view
      if (tab === 'leitos') {
        switchView('leitos');
      } else if (tab === 'dash-hospitalar') {
        switchView('dash-hospitalar');
      } else if (tab === 'dash-executivo') {
        switchView('dash-executivo');
      }
      
      // Close menu on mobile
      body.classList.remove('menu-open');
      sideMenu.classList.remove('open');
    });
  });

  // Settings menu
  const settingsBtn = document.getElementById('settingsMenuBtn');
  const settingsDropdown = document.getElementById('settingsMenuDropdown');
  
  if (settingsBtn) {
    settingsBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      settingsDropdown.classList.toggle('show');
    });
  }

  // Settings dropdown items
  const btnQRCodes = document.getElementById('btnQRCodes');
  const btnAdmin = document.getElementById('btnAdmin');
  
  if (btnQRCodes) {
    btnQRCodes.addEventListener('click', () => {
      showModal('modalBulkQR');
      settingsDropdown.classList.remove('show');
    });
  }
  
  if (btnAdmin) {
    btnAdmin.addEventListener('click', () => {
      showModal('modalADM');
      settingsDropdown.classList.remove('show');
    });
  }

  // Close dropdown when clicking outside
  document.addEventListener('click', () => {
    if (settingsDropdown) {
      settingsDropdown.classList.remove('show');
    }
  });
}

// =================== SISTEMA QR CODE ===================
function generateQRCodes() {
  logInfo('Gerando QR Codes...');
  
  const hospitalSelect = document.getElementById('qrHospitalSelect');
  const selectedHospital = hospitalSelect ? hospitalSelect.value : '';
  const grid = document.getElementById('qr_grid');
  
  if (!grid) return;
  
  grid.innerHTML = '';
  
  // Simular gera√ß√£o de QR codes
  const hospitais = selectedHospital ? [selectedHospital] : Object.keys(CONFIG.HOSPITAIS_CONFIG);
  
  hospitais.forEach(hospitalId => {
    const hospital = CONFIG.HOSPITAIS_CONFIG[hospitalId];
    for (let i = 1; i <= hospital.leitos; i++) {
      const qrCell = document.createElement('div');
      qrCell.className = 'qr-cell';
      qrCell.style.cssText = `
        background: white; border: 2px solid #000; border-radius: 8px;
        padding: 10px; text-align: center; width: 120px; height: 140px;
        display: flex; flex-direction: column; align-items: center;
        justify-content: center; margin: 5px;
      `;
      
      const qrContainer = document.createElement('div');
      qrContainer.style.cssText = 'width: 80px; height: 80px; margin-bottom: 8px;';
      
      const qrLabel = document.createElement('div');
      qrLabel.textContent = `${hospital.nome} - Leito ${i}`;
      qrLabel.style.cssText = 'font-size: 10px; color: #000; font-weight: bold;';
      
      qrCell.appendChild(qrContainer);
      qrCell.appendChild(qrLabel);
      
      // Generate QR code
      const qrCodeUrl = `${window.location.origin}?h=${hospitalId}&leito=${i}`;
      new QRCode(qrContainer, {
        text: qrCodeUrl,
        width: 80,
        height: 80,
        colorDark: "#000000",
        colorLight: "#ffffff"
      });
      
      grid.appendChild(qrCell);
    }
  });
  
  logSuccess(`QR Codes gerados para ${selectedHospital || 'todos os hospitais'}`);
}

// =================== HELPER FUNCTIONS ===================
function updateElement(id, value) {
  const element = document.getElementById(id);
  if (element) {
    element.textContent = value;
  }
}

// =================== INICIALIZA√á√ÉO E EVENT LISTENERS ===================
document.addEventListener('DOMContentLoaded', function() {
  logInfo('Sistema Archipelago Dashboard V3.0 Carregando...');
  
  initAuthentication();
  
  // Hospital selectors
  document.querySelectorAll('.hospital-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const hospital = btn.dataset.hospital;
      if (hospital) {
        setHospital(hospital);
      }
    });
  });

  // Refresh button
  const refreshBtn = document.getElementById('refreshBtn');
  if (refreshBtn) {
    refreshBtn.addEventListener('click', () => {
      loadData();
    });
  }

  // Modal close buttons
  document.querySelectorAll('.close-modal').forEach(btn => {
    btn.addEventListener('click', () => {
      const modalId = btn.dataset.modal;
      if (modalId) closeModal(modalId);
    });
  });

  // Form save button
  const formSave = document.getElementById('formSave');
  if (formSave) {
    formSave.addEventListener('click', saveFormData);
  }

  // Form discharge button
  const formDischarge = document.getElementById('formDischarge');
  if (formDischarge) {
    formDischarge.addEventListener('click', dischargePatient);
  }

  // ADM login button
  const admLogin = document.getElementById('admLogin');
  if (admLogin) {
    admLogin.addEventListener('click', () => {
      const email = document.getElementById('admEmail')?.value;
      const password = document.getElementById('admPassword')?.value;
      
      if (email === CONFIG.ADM_EMAIL && password === CONFIG.ADM_PASSWORD) {
        showSuccessMessage('Login ADM realizado com sucesso!');
        closeModal('modalADM');
        logSuccess('Acesso ADM autorizado');
      } else {
        const errorEl = document.getElementById('admError');
        if (errorEl) {
          errorEl.style.display = 'block';
          setTimeout(() => {
            errorEl.style.display = 'none';
          }, 2000);
        }
      }
    });
  }

  // QR Code generation
  const generateBulkQR = document.getElementById('generateBulkQR');
  if (generateBulkQR) {
    generateBulkQR.addEventListener('click', generateQRCodes);
  }

  const printQRCodes = document.getElementById('printQRCodes');
  if (printQRCodes) {
    printQRCodes.addEventListener('click', () => {
      window.print();
    });
  }

  logSuccess('Event listeners configurados');
});

// =================== SISTEMA DE IMPRESS√ÉO QR CODES ===================
const printStyles = document.createElement('style');
printStyles.textContent = `
@media print {
  @page { size: A4; margin: 10mm; }
  
  * { 
    -webkit-print-color-adjust: exact !important;
    color-adjust: exact !important;
    visibility: hidden !important;
  }

  #modalBulkQR, #modalBulkQR *, #qr_grid, #qr_grid *, .qr-cell, .qr-cell * {
    visibility: visible !important;
    opacity: 1 !important;
  }
  
  body { background: white !important; margin: 0 !important; padding: 0 !important; }
  
  #modalBulkQR {
    position: static !important; background: white !important;
    display: block !important; width: 100% !important;
    height: auto !important; max-width: none !important;
    max-height: none !important;
  }
  
  #modalBulkQR .modal {
    position: static !important; background: white !important;
    max-width: none !important; width: 100% !important;
    height: auto !important; margin: 0 !important;
    padding: 0 !important; border: none !important;
    box-shadow: none !important; display: block !important;
  }
  
  #modalBulkQR .content {
    padding: 0 !important; height: auto !important;
    display: block !important; overflow: visible !important;
  }
  
  #modalBulkQR header, #modalBulkQR .content > div:first-child,
  #modalBulkQR button, .btn {
    display: none !important; visibility: hidden !important;
  }
  
  #qr_grid {
    display: grid !important; grid-template-columns: repeat(3, 1fr) !important;
    gap: 8mm !important; padding: 5mm !important; width: 100% !important;
    height: auto !important; background: white !important;
    visibility: visible !important;
  }
  
  .qr-cell {
    background: white !important; border: 2px solid #000 !important;
    border-radius: 3mm !important; padding: 3mm !important;
    text-align: center !important; width: 60mm !important;
    height: 70mm !important; display: flex !important;
    flex-direction: column !important; align-items: center !important;
    justify-content: center !important; page-break-inside: avoid !important;
    visibility: visible !important; box-sizing: border-box !important;
  }
  
  .qr-cell:nth-child(9n) {
    page-break-after: always !important;
  }
  
  .qr-cell > div:first-child {
    width: 45mm !important; height: 45mm !important;
    display: flex !important; align-items: center !important;
    justify-content: center !important; margin-bottom: 2mm !important;
    background: white !important; visibility: visible !important;
  }
  
  .qr-cell img, .qr-cell canvas {
    width: 45mm !important; height: 45mm !important;
    max-width: 45mm !important; max-height: 45mm !important;
    visibility: visible !important; display: block !important;
    margin: 0 !important; opacity: 1 !important;
  }
  
  .qr-cell > div:last-child {
    font-size: 10pt !important; color: #000 !important;
    font-weight: bold !important; text-align: center !important;
    visibility: visible !important; display: block !important;
    margin-top: 2mm !important; line-height: 1.2 !important;
  }
}
`;
document.head.appendChild(printStyles);

logSuccess("‚úÖ PARTE 4/4 CARREGADA - DASHBOARDS + FINALIZA√á√ÉO COMPLETA");
logSuccess("üéØ Sistema Archipelago Dashboard V3.0 IMPLEMENTADO:");
logSuccess("- Autentica√ß√£o 170284 obrigat√≥ria");
logSuccess("- Timer 4 minutos configurado");
logSuccess("- Layout cards 3x3 conforme manual");
logSuccess("- Dashboard Executivo com 8 KPIs");
logSuccess("- Dashboard Hospitalar por hospital");
logSuccess("- Sistema QR Code completo");
logSuccess("- √Årea ADM com login correto");
logSuccess("- 55 cores Pantone aplicadas");
logSuccess("- Responsividade mobile implementada");
logSuccess("- Sistema de impress√£o QR otimizado");

</script>
</body>
</html>
